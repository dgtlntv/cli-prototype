<!DOCTYPE html>
<html>
    <head>
        <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
        <link href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.min.css" rel="stylesheet" />
        <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"></script>
        <style>
            @import url("https://fonts.googleapis.com/css2?family=Ubuntu+Mono:wght@400;700&display=swap");

            html,
            body {
                height: 100%;
                margin: 0;
                padding: 0;
                overflow: hidden;
                background-color: #330f25;
            }
            #terminal {
                height: 100%;
                width: 100%;
            }
            .xterm-viewport {
                overflow-y: auto;
                scrollbar-width: none;
                -ms-overflow-style: none;
            }
            .xterm-viewport::-webkit-scrollbar {
                width: 0;
                height: 0;
            }
            .xterm {
                padding: 20px;
                font-family: "Ubuntu Mono", monospace;
            }
            .xterm-screen {
                width: 100% !important;
            }
        </style>
    </head>
    <body>
        <div id="terminal"></div>
        <script>
            let customCommands = {}

            fetch("commands.json")
                .then((response) => response.json())
                .then((data) => {
                    if (data.welcome) {
                        welcomeMessage =
                            data.welcome.message ||
                            "Welcome to the Ubuntu Terminal!\nType 'help' to see a list of available commands."
                        welcomeColor = data.welcome.color || "white"
                    }
                    customCommands = data.commands || {}
                    initializeTerminal()
                })
                .catch((error) => {
                    console.error("Error loading commands:", error)
                    initializeTerminal()
                })

            function initializeTerminal() {
                const term = new Terminal({
                    cursorBlink: true,
                    fontSize: 18,
                    fontFamily: '"Ubuntu Mono", monospace',
                    fontWeight: 400,
                    theme: {
                        background: "#330F25",
                        foreground: "#ffffff",
                        cursor: "#ffffff",
                        selection: "rgba(255, 255, 255, 0.3)",
                        black: "#2e3436",
                        red: "#cc0000",
                        green: "#00975F",
                        yellow: "#c4a000",
                        blue: "#00407C",
                        magenta: "#75507b",
                        cyan: "#06989a",
                        white: "#d3d7cf",
                    },
                })

                const fitAddon = new FitAddon.FitAddon()
                term.loadAddon(fitAddon)
                term.open(document.getElementById("terminal"))

                term.attachCustomKeyEventHandler((event) => {
                    if ((event.ctrlKey || event.metaKey) && event.code === "KeyV" && event.type === "keydown") {
                        navigator.clipboard.readText().then((text) => {
                            term.write(text)
                        })
                        return false
                    }

                    if ((event.ctrlKey || event.metaKey) && event.code === "KeyC" && event.type === "keydown") {
                        const selection = term.getSelection()
                        if (selection) {
                            navigator.clipboard.writeText(selection)
                            return false
                        }
                    }

                    return true
                })

                fitAddon.fit()

                window.addEventListener("resize", () => fitAddon.fit())

                let input = ""
                let commandHistory = []
                let historyIndex = -1
                let cursorPosition = 0

                term.onKey(({ key, domEvent }) => {
                    const printable = !domEvent.altKey && !domEvent.ctrlKey && !domEvent.metaKey

                    if (domEvent.keyCode === 13) {
                        // Enter key
                        term.writeln("")
                        if (input.trim() !== "") {
                            commandHistory.unshift(input)
                            historyIndex = -1
                        }
                        handleCommand(input)
                        input = ""
                        cursorPosition = 0
                    } else if (domEvent.keyCode === 8) {
                        // Backspace
                        if (cursorPosition > 0) {
                            input = input.slice(0, cursorPosition - 1) + input.slice(cursorPosition)
                            cursorPosition--
                            term.write("\b \b")
                            term.write(input.slice(cursorPosition))
                            term.write("\x1b[K")
                            term.write("\x1b[" + (input.length - cursorPosition) + "D")
                        }
                    } else if (domEvent.keyCode === 37) {
                        // Left arrow
                        if (cursorPosition > 0) {
                            cursorPosition--
                            term.write(key)
                        }
                    } else if (domEvent.keyCode === 39) {
                        // Right arrow
                        if (cursorPosition < input.length) {
                            cursorPosition++
                            term.write(key)
                        }
                    } else if (domEvent.keyCode === 38) {
                        // Up arrow
                        if (historyIndex < commandHistory.length - 1) {
                            historyIndex++
                            input = commandHistory[historyIndex]
                            term.write(
                                "\x1b[2K\r\x1b[1;32muser@ubuntu\x1b[0m:\x1b[1;34m~\x1b[0m\x1b[37m$ \x1b[0m" + input
                            )
                            cursorPosition = input.length
                        }
                    } else if (domEvent.keyCode === 40) {
                        // Down arrow
                        if (historyIndex > -1) {
                            historyIndex--
                            if (historyIndex === -1) {
                                input = ""
                            } else {
                                input = commandHistory[historyIndex]
                            }
                            term.write(
                                "\x1b[2K\r\x1b[1;32muser@ubuntu\x1b[0m:\x1b[1;34m~\x1b[0m\x1b[37m$ \x1b[0m" + input
                            )
                            cursorPosition = input.length
                        }
                    } else if (printable) {
                        input = input.slice(0, cursorPosition) + key + input.slice(cursorPosition)
                        cursorPosition++
                        term.write(key)
                        if (cursorPosition < input.length) {
                            term.write(input.slice(cursorPosition))
                            term.write("\x1b[" + (input.length - cursorPosition) + "D")
                        }
                    }
                })

                function handleCommand(cmd) {
                    const args = cmd.trim().split(/\s+/)
                    const command = args[0].toLowerCase()
                    const flags = parseFlags(args.slice(1), command)

                    if (command === "clear") {
                        term.clear()
                        term.reset()
                        term.write("\x1b[H")
                        writePrompt()
                    } else if (command === "help") {
                        showGeneralHelp()
                    } else if (customCommands[command]) {
                        executeCommand(command, flags)
                    } else {
                        term.writeln(`Unknown command: ${command}`)
                        writePrompt()
                    }
                }

                function parseFlags(args, command) {
                    const flags = {}
                    const cmd = customCommands[command]
                    if (!cmd || !cmd.flags) return flags

                    const flagAliases = Object.entries(cmd.flags).reduce((acc, [flag, details]) => {
                        acc[flag] = flag
                        if (details.aliases) {
                            details.aliases.forEach((alias) => {
                                acc[alias] = flag
                            })
                        }
                        return acc
                    }, {})

                    for (let i = 0; i < args.length; i++) {
                        const arg = args[i]
                        const flagName = flagAliases[arg]
                        if (flagName) {
                            const flagDetails = cmd.flags[flagName]
                            if (flagDetails.requiresValue && i + 1 < args.length) {
                                flags[flagName] = args[++i]
                            } else {
                                flags[flagName] = true
                            }
                        }
                    }
                    return flags
                }

                function showGeneralHelp() {
                    term.writeln("Available commands:")
                    term.writeln("  help - Show available commands")
                    Object.keys(customCommands).forEach((command) => {
                        term.writeln(`  ${command} - ${customCommands[command].description}`)
                    })
                    term.writeln("\nType '<command> --help' for more information on a specific command.")
                    writePrompt()
                }

                function showCommandHelp(command) {
                    const cmd = customCommands[command]
                    if (cmd) {
                        term.writeln(`${command} - ${cmd.description}`)
                        if (cmd.flags) {
                            term.writeln("\nFlags:")
                            Object.entries(cmd.flags).forEach(([flag, details]) => {
                                const aliases = details.aliases ? ` (${details.aliases.join(", ")})` : ""
                                term.writeln(`  ${flag}${aliases}: ${details.description}`)
                            })
                        }
                    } else {
                        term.writeln(`No help available for '${command}'.`)
                    }
                }

                function executeCommand(command, flags) {
                    const cmd = customCommands[command]
                    if (flags["--help"]) {
                        showCommandHelp(command)
                        writePrompt()
                        return
                    }

                    let output = cmd.action

                    if (typeof output === "function") {
                        output = output()
                    }

                    Object.entries(flags).forEach(([flag, value]) => {
                        const flagDetails = cmd.flags && cmd.flags[flag]
                        if (flagDetails) {
                            if (flagDetails.requiresValue && value === true) {
                                output = `Error: ${flag} requires a value.`
                            } else if (flag === "--name" && command === "hello") {
                                output = `Hello, ${value}!\nWelcome to the terminal!`
                            }
                        }
                    })

                    writeColoredText(output, cmd.color)
                    term.write("\r\n")
                    writePrompt()
                }

                function writePrompt() {
                    const green = term.options.theme
                    console.log("Green color code:", green)
                    term.write("\r\n\x1b[1;32muser@ubuntu\x1b[0m:\x1b[1;34m~\x1b[0m\x1b[37m$ \x1b[0m")
                }

                function writeColoredText(text, color) {
                    const colorCodes = {
                        black: "\x1b[30m",
                        red: "\x1b[31m",
                        green: "\x1b[32m",
                        yellow: "\x1b[33m",
                        blue: "\x1b[34m",
                        magenta: "\x1b[35m",
                        cyan: "\x1b[36m",
                        white: "\x1b[37m",
                    }
                    const colorCode = color && colorCodes[color] ? colorCodes[color] : ""
                    const resetCode = colorCode ? "\x1b[0m" : ""

                    const lines = text.split("\n")
                    for (let i = 0; i < lines.length; i++) {
                        if (i > 0) term.write("\r\n")
                        term.write(`${colorCode}${lines[i]}${resetCode}`)
                    }
                }

                writeColoredText(welcomeMessage, welcomeColor)
                writePrompt()
            }
        </script>
    </body>
</html>
