<!DOCTYPE html>
<html>
    <head>
        <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
        <link href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.min.css" rel="stylesheet" />
        <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"></script>
        <style>
            @import url("https://fonts.googleapis.com/css2?family=Ubuntu+Sans+Mono:ital,wght@0,400..700;1,400..700&display=swap");

            html,
            body {
                height: 100%;
                margin: 0;
                padding: 0;
                overflow: hidden;
                background-color: #300a24;
            }
            #terminal {
                height: 100%;
                width: 100%;
            }
            .xterm-viewport {
                overflow-y: auto;
                scrollbar-width: none;
                -ms-overflow-style: none;
            }
            .xterm-viewport::-webkit-scrollbar {
                width: 0;
                height: 0;
            }
            .xterm {
                padding: 5px;
                font-family: "Ubuntu Sans Mono", monospace;
                font-weight: 350;
            }
            .xterm-screen {
                width: 100% !important;
            }
        </style>
    </head>
    <body>
        <div id="terminal"></div>
        <script>
            let customCommands = {}

            fetch("commands.json")
                .then((response) => response.json())
                .then((data) => {
                    customCommands = data
                    initializeTerminal()
                })
                .catch((error) => {
                    console.error("Error loading commands:", error)
                    initializeTerminal()
                })

            function initializeTerminal() {
                const term = new Terminal({
                    cursorBlink: true,
                    fontSize: 16,
                    fontFamily: '"Ubuntu Sans Mono", monospace',
                    fontWeight: 350,
                    theme: {
                        background: "#300a24",
                        foreground: "#ffffff",
                        cursor: "#ffffff",
                        selection: "rgba(255, 255, 255, 0.3)",
                        black: "#2e3436",
                        red: "#cc0000",
                        green: "#4e9a06",
                        yellow: "#c4a000",
                        blue: "#3465a4",
                        magenta: "#75507b",
                        cyan: "#06989a",
                        white: "#d3d7cf",
                        brightBlack: "#555753",
                        brightRed: "#ef2929",
                        brightGreen: "#8ae234",
                        brightYellow: "#fce94f",
                        brightBlue: "#729fcf",
                        brightMagenta: "#ad7fa8",
                        brightCyan: "#34e2e2",
                        brightWhite: "#eeeeec",
                    },
                })

                const fitAddon = new FitAddon.FitAddon()
                term.loadAddon(fitAddon)
                term.open(document.getElementById("terminal"))

                term.attachCustomKeyEventHandler((event) => {
                    if ((event.ctrlKey || event.metaKey) && event.code === "KeyV" && event.type === "keydown") {
                        navigator.clipboard.readText().then((text) => {
                            term.write(text)
                        })
                        return false
                    }

                    if ((event.ctrlKey || event.metaKey) && event.code === "KeyC" && event.type === "keydown") {
                        const selection = term.getSelection()
                        if (selection) {
                            navigator.clipboard.writeText(selection)
                            return false
                        }
                    }

                    return true
                })

                fitAddon.fit()

                window.addEventListener("resize", () => fitAddon.fit())

                let input = ""
                let commandHistory = []
                let historyIndex = -1
                let cursorPosition = 0

                term.onKey(({ key, domEvent }) => {
                    const printable = !domEvent.altKey && !domEvent.ctrlKey && !domEvent.metaKey

                    if (domEvent.keyCode === 13) {
                        // Enter key
                        term.writeln("")
                        if (input.trim() !== "") {
                            commandHistory.unshift(input)
                            historyIndex = -1
                        }
                        handleCommand(input)
                        input = ""
                        cursorPosition = 0
                    } else if (domEvent.keyCode === 8) {
                        // Backspace
                        if (cursorPosition > 0) {
                            input = input.slice(0, cursorPosition - 1) + input.slice(cursorPosition)
                            cursorPosition--
                            term.write("\b \b")
                            term.write(input.slice(cursorPosition))
                            term.write("\x1b[K")
                            term.write("\x1b[" + (input.length - cursorPosition) + "D")
                        }
                    } else if (domEvent.keyCode === 37) {
                        // Left arrow
                        if (cursorPosition > 0) {
                            cursorPosition--
                            term.write(key)
                        }
                    } else if (domEvent.keyCode === 39) {
                        // Right arrow
                        if (cursorPosition < input.length) {
                            cursorPosition++
                            term.write(key)
                        }
                    } else if (domEvent.keyCode === 38) {
                        // Up arrow
                        if (historyIndex < commandHistory.length - 1) {
                            historyIndex++
                            input = commandHistory[historyIndex]
                            term.write("\x1b[2K\r\x1b[1;32muser@ubuntu\x1b[0m:\x1b[1;34m~\x1b[0m$ " + input)
                            cursorPosition = input.length
                        }
                    } else if (domEvent.keyCode === 40) {
                        // Down arrow
                        if (historyIndex > -1) {
                            historyIndex--
                            if (historyIndex === -1) {
                                input = ""
                            } else {
                                input = commandHistory[historyIndex]
                            }
                            term.write("\x1b[2K\r\x1b[1;32muser@ubuntu\x1b[0m:\x1b[1;34m~\x1b[0m$ " + input)
                            cursorPosition = input.length
                        }
                    } else if (printable) {
                        input = input.slice(0, cursorPosition) + key + input.slice(cursorPosition)
                        cursorPosition++
                        term.write(key)
                        if (cursorPosition < input.length) {
                            term.write(input.slice(cursorPosition))
                            term.write("\x1b[" + (input.length - cursorPosition) + "D")
                        }
                    }
                })

                function handleCommand(cmd) {
                    const trimmedCmd = cmd.trim().toLowerCase()
                    if (trimmedCmd === "clear") {
                        term.clear()
                        term.reset() // This resets the terminal state
                        term.write("\x1b[H") // This moves the cursor to the top-left corner
                        writePrompt()
                    } else if (trimmedCmd === "help") {
                        term.writeln("Available commands:")
                        term.writeln("  help  - Show this help message")
                        term.writeln("  clear - Clear the terminal")
                        Object.keys(customCommands).forEach((command) => {
                            term.writeln(`  ${command} - ${customCommands[command].description}`)
                        })
                        writePrompt()
                    } else if (customCommands[trimmedCmd]) {
                        term.writeln(customCommands[trimmedCmd].action)
                        writePrompt()
                    } else {
                        term.writeln(`Unknown command: ${cmd}`)
                        writePrompt()
                    }
                }

                function writePrompt() {
                    term.write("\r\n\x1b[1;32muser@ubuntu\x1b[0m:\x1b[1;34m~\x1b[0m$ ")
                }

                term.writeln("\x1b[1;36mWelcome to the Ubuntu Terminal!\x1b[0m")
                term.writeln('Type "help" for available commands.')
                writePrompt()
            }
        </script>
    </body>
</html>
